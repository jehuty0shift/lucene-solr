#include <stdint.h>
#include <defs.h>

#include "dpu_output.h"

#define K (1.2f)
#define B (0.75f)

/* precision of the log function (already taken into account in "cache_log")*/
#define LOG_PRECISION_SHIFT (10)
#define LOG_PRECISION (1 << LOG_PRECISION_SHIFT)

#define CACHE_SIZE (256)
#define NB_SEGMENT (18)
static short segments[NB_SEGMENT] =
    {
     0,
     128, /* incr: 1*/
     136, /* incr: 2*/
     144, /* incr: 4*/
     152, /* incr: 8*/
     160, /* incr: 16*/
     168, /* incr: 32*/
     176, /* incr: 64*/
     184, /* incr: 128*/
     192, /* incr: 256*/
     200, /* incr: 512*/
     208, /* incr: 1024*/
     216, /* incr: 2048*/
     224, /* incr: 4096*/
     232, /* incr: 8192*/
     240, /* incr: 16384*/
     248, /* incr: 32768*/
     256,
    };
static short cache_log[CACHE_SIZE] =
    {
     415,
     709,
     938,
     1124,
     1282,
     1419,
     1540,
     1648,
     1745,
     1834,
     1916,
     1992,
     2063,
     2129,
     2191,
     2249,
     2305,
     2357,
     2407,
     2455,
     2500,
     2544,
     2586,
     2626,
     2665,
     2702,
     2738,
     2773,
     2806,
     2839,
     2870,
     2901,
     2930,
     2959,
     2987,
     3015,
     3041,
     3067,
     3092,
     3117,
     3141,
     3165,
     3188,
     3210,
     3232,
     3254,
     3275,
     3296,
     3316,
     3336,
     3355,
     3374,
     3393,
     3412,
     3430,
     3448,
     3465,
     3482,
     3499,
     3516,
     3532,
     3548,
     3564,
     3580,
     3595,
     3610,
     3625,
     3640,
     3655,
     3669,
     3683,
     3697,
     3711,
     3724,
     3738,
     3751,
     3764,
     3777,
     3790,
     3802,
     3815,
     3827,
     3839,
     3851,
     3863,
     3875,
     3886,
     3898,
     3909,
     3920,
     3931,
     3942,
     3953,
     3964,
     3974,
     3985,
     3995,
     4005,
     4016,
     4026,
     4036,
     4046,
     4055,
     4065,
     4075,
     4084,
     4094,
     4103,
     4112,
     4121,
     4131,
     4140,
     4149,
     4157,
     4166,
     4175,
     4184,
     4192,
     4201,
     4209,
     4217,
     4226,
     4234,
     4242,
     4250,
     4258,
     4266,
     4274,
     4282,
     4297,
     4313,
     4328,
     4343,
     4357,
     4372,
     4386,
     4400,
     4427,
     4454,
     4480,
     4506,
     4531,
     4555,
     4578,
     4602,
     4646,
     4689,
     4730,
     4770,
     4808,
     4845,
     4880,
     4915,
     4980,
     5041,
     5099,
     5154,
     5206,
     5256,
     5303,
     5348,
     5433,
     5511,
     5584,
     5651,
     5715,
     5775,
     5832,
     5885,
     5985,
     6075,
     6159,
     6236,
     6307,
     6374,
     6437,
     6497,
     6606,
     6704,
     6794,
     6877,
     6953,
     7024,
     7091,
     7153,
     7268,
     7371,
     7464,
     7550,
     7629,
     7703,
     7771,
     7835,
     7953,
     8058,
     8154,
     8241,
     8322,
     8396,
     8466,
     8531,
     8650,
     8757,
     8853,
     8942,
     9023,
     9098,
     9168,
     9234,
     9354,
     9461,
     9558,
     9647,
     9728,
     9804,
     9874,
     9940,
     10060,
     10168,
     10265,
     10354,
     10436,
     10512,
     10582,
     10648,
     10768,
     10876,
     10974,
     11063,
     11145,
     11220,
     11291,
     11357,
     11477,
     11585,
     11683,
     11772,
     11854,
     11930,
     12000,
     12066,
     12187,
     12295,
     12392,
     12481,
     12563,
     12639,
     12710,
     12776,
     12896,
     13004,
     13102,
     13191,
     13273,
     13349,
     13419,
    };
static int cache_log_idx[CACHE_SIZE]=
    {
     3, /* 0 */
     4, /* 1 */
     5, /* 2 */
     6, /* 3 */
     7, /* 4 */
     8, /* 5 */
     9, /* 6 */
     10, /* 7 */
     11, /* 8 */
     12, /* 9 */
     13, /* 10 */
     14, /* 11 */
     15, /* 12 */
     16, /* 13 */
     17, /* 14 */
     18, /* 15 */
     19, /* 16 */
     20, /* 17 */
     21, /* 18 */
     22, /* 19 */
     23, /* 20 */
     24, /* 21 */
     25, /* 22 */
     26, /* 23 */
     27, /* 24 */
     28, /* 25 */
     29, /* 26 */
     30, /* 27 */
     31, /* 28 */
     32, /* 29 */
     33, /* 30 */
     34, /* 31 */
     35, /* 32 */
     36, /* 33 */
     37, /* 34 */
     38, /* 35 */
     39, /* 36 */
     40, /* 37 */
     41, /* 38 */
     42, /* 39 */
     43, /* 40 */
     44, /* 41 */
     45, /* 42 */
     46, /* 43 */
     47, /* 44 */
     48, /* 45 */
     49, /* 46 */
     50, /* 47 */
     51, /* 48 */
     52, /* 49 */
     53, /* 50 */
     54, /* 51 */
     55, /* 52 */
     56, /* 53 */
     57, /* 54 */
     58, /* 55 */
     59, /* 56 */
     60, /* 57 */
     61, /* 58 */
     62, /* 59 */
     63, /* 60 */
     64, /* 61 */
     65, /* 62 */
     66, /* 63 */
     67, /* 64 */
     68, /* 65 */
     69, /* 66 */
     70, /* 67 */
     71, /* 68 */
     72, /* 69 */
     73, /* 70 */
     74, /* 71 */
     75, /* 72 */
     76, /* 73 */
     77, /* 74 */
     78, /* 75 */
     79, /* 76 */
     80, /* 77 */
     81, /* 78 */
     82, /* 79 */
     83, /* 80 */
     84, /* 81 */
     85, /* 82 */
     86, /* 83 */
     87, /* 84 */
     88, /* 85 */
     89, /* 86 */
     90, /* 87 */
     91, /* 88 */
     92, /* 89 */
     93, /* 90 */
     94, /* 91 */
     95, /* 92 */
     96, /* 93 */
     97, /* 94 */
     98, /* 95 */
     99, /* 96 */
     100, /* 97 */
     101, /* 98 */
     102, /* 99 */
     103, /* 100 */
     104, /* 101 */
     105, /* 102 */
     106, /* 103 */
     107, /* 104 */
     108, /* 105 */
     109, /* 106 */
     110, /* 107 */
     111, /* 108 */
     112, /* 109 */
     113, /* 110 */
     114, /* 111 */
     115, /* 112 */
     116, /* 113 */
     117, /* 114 */
     118, /* 115 */
     119, /* 116 */
     120, /* 117 */
     121, /* 118 */
     122, /* 119 */
     123, /* 120 */
     124, /* 121 */
     125, /* 122 */
     126, /* 123 */
     127, /* 124 */
     128, /* 125 */
     129, /* 126 */
     130, /* 127 */
     131, /* 128 */
     133, /* 129 */
     135, /* 130 */
     137, /* 131 */
     139, /* 132 */
     141, /* 133 */
     143, /* 134 */
     145, /* 135 */
     147, /* 136 */
     151, /* 137 */
     155, /* 138 */
     159, /* 139 */
     163, /* 140 */
     167, /* 141 */
     171, /* 142 */
     175, /* 143 */
     179, /* 144 */
     187, /* 145 */
     195, /* 146 */
     203, /* 147 */
     211, /* 148 */
     219, /* 149 */
     227, /* 150 */
     235, /* 151 */
     243, /* 152 */
     259, /* 153 */
     275, /* 154 */
     291, /* 155 */
     307, /* 156 */
     323, /* 157 */
     339, /* 158 */
     355, /* 159 */
     371, /* 160 */
     403, /* 161 */
     435, /* 162 */
     467, /* 163 */
     499, /* 164 */
     531, /* 165 */
     563, /* 166 */
     595, /* 167 */
     627, /* 168 */
     691, /* 169 */
     755, /* 170 */
     819, /* 171 */
     883, /* 172 */
     947, /* 173 */
     1011, /* 174 */
     1075, /* 175 */
     1139, /* 176 */
     1267, /* 177 */
     1395, /* 178 */
     1523, /* 179 */
     1651, /* 180 */
     1779, /* 181 */
     1907, /* 182 */
     2035, /* 183 */
     2163, /* 184 */
     2419, /* 185 */
     2675, /* 186 */
     2931, /* 187 */
     3187, /* 188 */
     3443, /* 189 */
     3699, /* 190 */
     3955, /* 191 */
     4211, /* 192 */
     4723, /* 193 */
     5235, /* 194 */
     5747, /* 195 */
     6259, /* 196 */
     6771, /* 197 */
     7283, /* 198 */
     7795, /* 199 */
     8307, /* 200 */
     9331, /* 201 */
     10355, /* 202 */
     11379, /* 203 */
     12403, /* 204 */
     13427, /* 205 */
     14451, /* 206 */
     15475, /* 207 */
     16499, /* 208 */
     18547, /* 209 */
     20595, /* 210 */
     22643, /* 211 */
     24691, /* 212 */
     26739, /* 213 */
     28787, /* 214 */
     30835, /* 215 */
     32883, /* 216 */
     36979, /* 217 */
     41075, /* 218 */
     45171, /* 219 */
     49267, /* 220 */
     53363, /* 221 */
     57459, /* 222 */
     61555, /* 223 */
     65651, /* 224 */
     73843, /* 225 */
     82035, /* 226 */
     90227, /* 227 */
     98419, /* 228 */
     106611, /* 229 */
     114803, /* 230 */
     122995, /* 231 */
     131187, /* 232 */
     147571, /* 233 */
     163955, /* 234 */
     180339, /* 235 */
     196723, /* 236 */
     213107, /* 237 */
     229491, /* 238 */
     245875, /* 239 */
     262259, /* 240 */
     295027, /* 241 */
     327795, /* 242 */
     360563, /* 243 */
     393331, /* 244 */
     426099, /* 245 */
     458867, /* 246 */
     491635, /* 247 */
     524403, /* 248 */
     589939, /* 249 */
     655475, /* 250 */
     721011, /* 251 */
     786547, /* 252 */
     852083, /* 253 */
     917619, /* 254 */
     983155, /* 255 */
    };
static int cache_norm[CACHE_SIZE] =
    {
     0,
     1,
     2,
     3,
     4,
     5,
     6,
     7,
     8,
     9,
     10,
     11,
     12,
     13,
     14,
     15,
     16,
     17,
     18,
     19,
     20,
     21,
     22,
     23,
     24,
     25,
     26,
     27,
     28,
     29,
     30,
     31,
     32,
     33,
     34,
     35,
     36,
     37,
     38,
     39,
     40,
     42,
     44,
     46,
     48,
     50,
     52,
     54,
     56,
     60,
     64,
     68,
     72,
     76,
     80,
     84,
     88,
     96,
     104,
     112,
     120,
     128,
     136,
     144,
     152,
     168,
     184,
     200,
     216,
     232,
     248,
     264,
     280,
     312,
     344,
     376,
     408,
     440,
     472,
     504,
     536,
     600,
     664,
     728,
     792,
     856,
     920,
     984,
     1048,
     1176,
     1304,
     1432,
     1560,
     1688,
     1816,
     1944,
     2072,
     2328,
     2584,
     2840,
     3096,
     3352,
     3608,
     3864,
     4120,
     4632,
     5144,
     5656,
     6168,
     6680,
     7192,
     7704,
     8216,
     9240,
     10264,
     11288,
     12312,
     13336,
     14360,
     15384,
     16408,
     18456,
     20504,
     22552,
     24600,
     26648,
     28696,
     30744,
     32792,
     36888,
     40984,
     45080,
     49176,
     53272,
     57368,
     61464,
     65560,
     73752,
     81944,
     90136,
     98328,
     106520,
     114712,
     122904,
     131096,
     147480,
     163864,
     180248,
     196632,
     213016,
     229400,
     245784,
     262168,
     294936,
     327704,
     360472,
     393240,
     426008,
     458776,
     491544,
     524312,
     589848,
     655384,
     720920,
     786456,
     851992,
     917528,
     983064,
     1048600,
     1179672,
     1310744,
     1441816,
     1572888,
     1703960,
     1835032,
     1966104,
     2097176,
     2359320,
     2621464,
     2883608,
     3145752,
     3407896,
     3670040,
     3932184,
     4194328,
     4718616,
     5242904,
     5767192,
     6291480,
     6815768,
     7340056,
     7864344,
     8388632,
     9437208,
     10485784,
     11534360,
     12582936,
     13631512,
     14680088,
     15728664,
     16777240,
     18874392,
     20971544,
     23068696,
     25165848,
     27263000,
     29360152,
     31457304,
     33554456,
     37748760,
     41943064,
     46137368,
     50331672,
     54525976,
     58720280,
     62914584,
     67108888,
     75497496,
     83886104,
     92274712,
     100663320,
     109051928,
     117440536,
     125829144,
     134217760,
     150994976,
     167772192,
     184549408,
     201326624,
     218103840,
     234881056,
     251658272,
     268435488,
     301989920,
     335544352,
     369098784,
     402653216,
     436207648,
     469762080,
     503316512,
     536870910,
     603979780,
     671088640,
     738197500,
     805306370,
     872415230,
     939524100,
     1006632960,
     1073741820,
     1207959550,
     1342177280,
     1476395010,
     1610612740,
     1744830460,
     1879048190,
     2013265920,
    };

static int compute_log_idx(int val)
{
    int each_segment;
    for (each_segment = 1; each_segment < (NB_SEGMENT - 1); each_segment++) {
        if (val < cache_log_idx[segments[each_segment]]) {
            int prev_segment = each_segment -1;
            int floor = segments[prev_segment];
            return floor + ((val - cache_log_idx[floor]) >> (prev_segment));
        }
    }
    halt();
    return 0;
}

static int compute_log(int val, int plus)
{
    int x = (val << 1) + plus;
    int idx = compute_log_idx(x);
    int x1 = cache_log_idx[idx];
    int x2 = cache_log_idx[idx + 1];
    int y1 = cache_log[idx];
    int y2 = cache_log[idx + 1];
    return (x - x1) * (y2 - y1) / (x2 - x1) + y1;
}

long long compute_bm25(uint32_t doc_count,
                       uint32_t doc_freq,
                       int32_t freq,
                       uint32_t doc_norm,
                       int64_t total_term_freq)
{
    long long weight = compute_log(doc_count, 2) - compute_log(doc_freq, 1);
    long long ft = freq * total_term_freq;
    long long num = weight * ft;
    long long den = (ft << LOG_PRECISION_SHIFT)
        + ((long long)(LOG_PRECISION * K * (1 -B))) * total_term_freq
        + ((long long)(LOG_PRECISION * K * B     )) * doc_count * (long long)cache_norm[doc_norm & 0xFF];
    return (num << SCORE_PRECISION_SHIFT) / den;
}

/* void generate_cache_log_idx() */
/* { */
/*         int cache_value = 3; */
/*         int cache_entry = 0; */
/*         int each_segment = 1; */
/*         for (; each_segment < NB_SEGMENT; each_segment++) { */
/*                 for (; cache_entry < segment[each_segment]; cache_entry++) { */
/*                         printf("%i, /\* %i *\/\n", cache_value, cache_entry); */
/*                         cache_value+= (1 << (each_segment-1)); */
/*                 } */
/*         } */
/* } */

/* void generate_cache_log() */
/* { */
/*         int each_cache_entry = 0; */
/*         for (; each_cache_entry < CACHE_SIZE; each_cache_entry++) { */
/*                 printf("%lli,\n", (long long)(LOG_PRECISION*log(((float)cache_log_idx[each_cache_entry]) / 2.0))); */
/*         } */
/* } */
